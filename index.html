<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Harp Server</title>
    <link href="style.css" rel="stylesheet">
  </head>
  <body>
    <script>
      var remote = require("remote");
      var shell = remote.require("shell");
      document.onclick = function(e) {
        e.preventDefault();
        if (e.target.tagName == 'A')
          shell.openExternal(e.target.href);
        return false;
      };
      document.ondragover = document.ondrop = function(e) {
        e.preventDefault();
        return false;
      };
    </script>
    <div id="alert-message" class="close" onclick="CloseAlert()">
         <div class="alertcontent">
         <div id="close-alert" class="close-button">&#x2715;</div>
         <h3 id="alert-title">Title</h3>
        <p id="alert-description">Something wrong.<p>
      </div>
    </div>
    <div id="server-status">
      <div class="data-status">
        <div id="app-path"></div>
        <div class="visual">
          <div class="bluline"></div>
          <div id="folder" class="folder">
            <img class="folderback" src="images/open-folder-back.svg">
            <img class="folderfront" src="images/open-folder-front.svg">
          </div>
        </div>
        <div class="info">
          <div class="title">Your server is listening at</div>
          <div id="server-url"></div>
        </div>
        <div class="controls">
          <a id="launch" class="button">View in Browser</a>
          <div id="build-app" class="button">Compile App</div>
        </div>
      </div>
    </div>

    <div id="splashscreen">
      <div class="container">
        <h1>Server is not running</h1>
        <div id="holder">
          <img src="images/drag-folder.svg">
        </div>
        <div class="label">Drag a Harp app folder here to get started.</div>
      </div>
    </div>

    <footer class="footerbar">
      <div class="left">
        <a href="http://harpjs.com/faq">FAQ</a> | <a href="https://github.com/alexgleason/harp-gui">GitHub</a>
      </div>
      <div class="right">
        <a href="http://harpjs.com/">About Harp</a>
      </div>
    </footer>

    <script>
      var harp = require("harp");
      var path = require("path");
      var fs = require("fs");
      var enableDestroy = require("server-destroy");
      var dialog = remote.require('dialog');
      var holder = document.getElementById('holder');
      var server = null;
      var appPath = '';
      var port = 0;

      function highlightLastPathDirectory(filename) {
        var i = filename.lastIndexOf(path.sep) + 1;
        var html = filename.substring(0, i);
        html += '<span class="highlighted">';
        html += filename.substring(i, filename.length);
        html += '</span>';
        return html;
      }

    function OpenAlert(title,description){
      var popup = document.getElementById('alert-message');
      document.getElementById('alert-title').innerHTML =  title;
      document.getElementById('alert-description').innerHTML =  description;

      popup.classList.remove('close');
    }
    function CloseAlert(){
      var popup = document.getElementById('alert-message');
      popup.classList.add('close');
    }
    function StopCompileLoading(){
      var folder = document.getElementById('server-status');
      folder.classList.remove('loading');
    }
    function StarCompileLoading(){
      var folder = document.getElementById('server-status');
      folder.classList.add('loading');
    }
      function startAppServer(file) {
        appPath = path.resolve(process.cwd(), file || "");

        if (server !== null)
          server.destroy();
        harp.server(appPath, {
            ip: '0.0.0.0',
            port: port
          }, function() {
            server = this;
            enableDestroy(this);
            port = this.address().port;
            var url = "http://localhost:" + port + "/";
            document.getElementById('app-path').innerHTML = highlightLastPathDirectory(appPath);
            document.getElementById('launch').href = url;
            document.getElementById('server-url').innerHTML = '<a href="' + url + '">' + url + '</a>';
            document.body.className = 'server-on';
          });
      }

      holder.onclick = function() {
        dialog.showOpenDialog({
          title: 'Choose an app folder',
          properties: [ 'openDirectory' ]
        }, function(filepaths) {
          if (typeof filepaths == 'undefined') return;
          var file = filepaths[0];
          startAppServer(file);
        });
      }
      holder.ondragover = function() {
        this.className = 'hover';
        return false;
      };
      holder.ondragleave = holder.ondragend = function() {
        this.className = '';
        return false;
      };
      holder.ondrop = function(e) {
        this.className = '';
        e.preventDefault();
        var file = e.dataTransfer.files[0].path;
        if(!fs.lstatSync(file).isDirectory()) {
          OpenAlert("That won't work", "You dropped a file, but you must drop an app folder.")
          return false;
        }
        startAppServer(file);
        return false;
      };

      document.getElementById('build-app').onclick = function() {
        StarCompileLoading();
        var outPath = path.resolve(appPath, '_build');
        harp.compile(appPath, outPath, function() {
          shell.openItem(outPath);
          StopCompileLoading();
        });
      }
    </script>
  </body>
</html>
