<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Harp Server</title>
    <link href="style.css" rel="stylesheet">
  </head>
  <body>
    <script>
      var remote = require("remote");
      document.onclick = function(e) {
        e.preventDefault();
        if (e.target.tagName == 'A')
          remote.require('shell').openExternal(e.target.href);
        return false;
      };
      document.ondragover = document.ondrop = function(e) {
        e.preventDefault();
        return false;
      };
    </script>

    <div id="server-status">
      <div class="data-status">
        <div id="app-path"></div>
        <div class="visual">
          <div class="bluline"></div>
          <img class="folderopen" src="images/open-folder.svg">
        </div>
        <div class="info">
          <div class="title">Your server is listening at</div>
          <div id="server-url"></div>
        </div>
        <div class="controls">
          <a id="launch">View in Browser</a>
        </div>
      </div>
    </div>

    <div id="splashscreen">
      <div class="container">
        <h1>Server is not running</h1>
        <div id="holder">
          <img src="images/drag-folder.svg">
        </div>
        <div class="label">Drag a Harp app folder here to get started.</div>
      </div>
    </div>

    <footer class="footerbar">
      <div class="left">
        <a href="http://harpjs.com/faq">FAQ</a> | <a href="https://github.com/alexgleason/harp-gui">GitHub</a>
      </div>
      <div class="right">
        <a href="http://harpjs.com/">About Harp</a>
      </div>
    </footer>

    <script>
      var harp = require("harp");
      var path = require("path");
      var enableDestroy = require("server-destroy");
      var dialog = remote.require('dialog');
      var holder = document.getElementById('holder');
      var server = null;
      var port = 0;

      function startAppServer(appPath) {
        var appPath = path.resolve(process.cwd(), appPath || "");

        if (server !== null)
          server.destroy();
        harp.server(appPath, {
            ip: '0.0.0.0',
            port: port
          }, function() {
            server = this;
            enableDestroy(this);
            port = this.address().port;
            var url = "http://localhost:" + port + "/";
            document.getElementById('app-path').innerHTML = appPath;
            document.getElementById('launch').href = url;
            document.getElementById('server-url').innerHTML = '<a href="' + url + '">' + url + '</a>';
            document.body.className = 'server-on';
          });
      }

      holder.onclick = function() {
        dialog.showOpenDialog({
          title: 'Choose an app folder',
          properties: [ 'openDirectory' ]
        }, function(filepaths) {
          var appPath = filepaths[0];
          startAppServer(appPath);
        });
      }
      holder.ondragover = function() {
        this.className = 'hover';
        return false;
      };
      holder.ondragleave = holder.ondragend = function() {
        this.className = '';
        return false;
      };
      holder.ondrop = function(e) {
        this.className = '';
        e.preventDefault();
        var appPath = e.dataTransfer.files[0].path;
        startAppServer(appPath);
        return false;
      };
    </script>
  </body>
</html>
